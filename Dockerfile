# =============================================================================
# Statelix Docker Development Environment
# =============================================================================
# このDockerfileは、Statelixのビルド・テスト環境を再現可能にします。
# どのPCでも同じ環境でビルド・テストできます。
# =============================================================================

FROM python:3.10-slim-bullseye

LABEL maintainer="Statelix Team"
LABEL description="Statelix - High-performance Statistical Analysis"

# =============================================================================
# 1. システム依存関係のインストール
# =============================================================================
RUN apt-get update && apt-get install -y --no-install-recommends \
    # C++ビルドツール
    build-essential \
    cmake \
    g++ \
    # OpenMP (並列処理)
    libomp-dev \
    # Git (バージョン管理)
    git \
    # Qt/PySide6 依存関係 (GUI用)
    libgl1-mesa-glx \
    libglib2.0-0 \
    libxkbcommon0 \
    libdbus-1-3 \
    libxcb-xinerama0 \
    libxcb-cursor0 \
    libegl1 \
    libxcb-icccm4 \
    libxcb-image0 \
    libxcb-keysyms1 \
    libxcb-randr0 \
    libxcb-render-util0 \
    libxcb-shape0 \
    # クリーンアップ
    && rm -rf /var/lib/apt/lists/*

# =============================================================================
# 2. Python依存関係のインストール
# =============================================================================
COPY requirements.txt /tmp/requirements.txt
RUN pip install --no-cache-dir --upgrade pip \
    && pip install --no-cache-dir -r /tmp/requirements.txt

# =============================================================================
# 3. 作業ディレクトリの設定
# =============================================================================
WORKDIR /statelix

# =============================================================================
# 4. ソースコードのコピー
# =============================================================================
COPY . /statelix

# =============================================================================
# 5. C++拡張のビルドとインストール
# =============================================================================
ENV STATELIX_NO_CUDA=1
RUN pip install -e .

# =============================================================================
# 6. デフォルトコマンド
# =============================================================================
# テストを実行（GUIなし）
CMD ["python", "-m", "pytest", "tests/", "-v", "--ignore=tests/gui"]
